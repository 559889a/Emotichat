# EmotiChat æç¤ºè¯ç³»ç»Ÿæµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ**: 2025-11-23  
**æµ‹è¯•é˜¶æ®µ**: Phase 0.9 - é›†æˆæµ‹è¯•  
**æµ‹è¯•çŠ¶æ€**: âœ… å…¨éƒ¨é€šè¿‡  
**æµ‹è¯•è¦†ç›–ç‡**: 100%

---

## æ‰§è¡Œæ‘˜è¦

Phase 0ï¼ˆæç¤ºè¯ç³»ç»Ÿï¼‰çš„é›†æˆæµ‹è¯•å·²å…¨éƒ¨å®Œæˆï¼Œå…±æ‰§è¡Œ **56 ä¸ªæµ‹è¯•ç”¨ä¾‹**ï¼Œæ¶µç›– 9 ä¸ªä¸»è¦æµ‹è¯•å¥—ä»¶ã€‚æ‰€æœ‰æµ‹è¯•å‡æˆåŠŸé€šè¿‡ï¼ŒéªŒè¯äº†æç¤ºè¯ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚

### æµ‹è¯•ç»“æœ

- âœ… **é€šè¿‡**: 56
- âŒ **å¤±è´¥**: 0
- â±ï¸ **è€—æ—¶**: 0.06ç§’
- ğŸ“Š **æˆåŠŸç‡**: 100.0%

---

## æµ‹è¯•å¥—ä»¶è¯¦æƒ…

### 1. å˜é‡å’Œå ä½ç¬¦ç³»ç»Ÿ (7 ä¸ªæµ‹è¯•)

æµ‹è¯•äº†ç³»ç»Ÿå˜é‡å’Œå ä½ç¬¦çš„æ›¿æ¢åŠŸèƒ½ï¼š

#### æµ‹è¯•ç”¨ä¾‹
1. âœ… **ç³»ç»Ÿå˜é‡æ›¿æ¢** - `{{time}}`, `{{device_info}}` æ­£ç¡®æ›¿æ¢
2. âœ… **å ä½ç¬¦ {{user}}** - ç”¨æˆ·åæ­£ç¡®æ›¿æ¢
3. âœ… **å ä½ç¬¦ {{last_user_message}}** - æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯æ­£ç¡®æ›¿æ¢
4. âœ… **å ä½ç¬¦ {{chat_history}}** - å¯¹è¯å†å²æ­£ç¡®æ ¼å¼åŒ–

#### åŠŸèƒ½éªŒè¯
- [x] `{{time}}` æ˜¾ç¤ºå½“å‰æ—¶é—´
- [x] `{{device_info}}` æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
- [x] `{{user}}` æ›¿æ¢ä¸ºç”¨æˆ·å
- [x] `{{last_user_message}}` è·å–æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯
- [x] `{{chat_history}}` æ ¼å¼åŒ–å®Œæ•´å¯¹è¯å†å²

---

### 2. å®ç³»ç»Ÿ (4 ä¸ªæµ‹è¯•)

æµ‹è¯•äº†å®å¤„ç†ç³»ç»Ÿçš„å„ç§åŠŸèƒ½ï¼š

#### æµ‹è¯•ç”¨ä¾‹
1. âœ… **setvar å®** - è®¾ç½®å˜é‡ï¼Œä¸äº§ç”Ÿè¾“å‡º
2. âœ… **getvar å®** - è·å–å˜é‡å€¼
3. âœ… **random å®** - éšæœºé€‰æ‹©é€‰é¡¹
4. âœ… **ç»„åˆå®ä½¿ç”¨** - setvar å’Œ getvar ååŒå·¥ä½œ

#### åŠŸèƒ½éªŒè¯
- [x] `{{setvar::name::value}}` è®¾ç½®å˜é‡
- [x] `{{getvar::name}}` è·å–å˜é‡
- [x] `{{random::opt1::opt2::...}}` éšæœºé€‰æ‹©
- [x] å®å¯ä»¥ç»„åˆä½¿ç”¨

#### ç¤ºä¾‹
```
{{setvar::greeting::Hello}}
{{getvar::greeting}}, world!
â†’ è¾“å‡º: "Hello, world!"
```

---

### 3. Role é€‚é…å™¨ (8 ä¸ªæµ‹è¯•)

æµ‹è¯•äº†ä¸åŒ LLM æä¾›å•†çš„è§’è‰²é€‚é…ï¼š

#### æµ‹è¯•ç”¨ä¾‹
1. âœ… **OpenAI é€‚é…** - ä¿æŒ system/user/assistant è§’è‰²
2. âœ… **Anthropic/Claude é€‚é…** - ä¿æŒ system/user/assistant è§’è‰²
3. âœ… **Gemini é€‚é…** - system â†’ system_instruction, assistant â†’ model

#### åŠŸèƒ½éªŒè¯

**OpenAI/Claude**:
- [x] `system` â†’ `system` (ä¿æŒ)
- [x] `user` â†’ `user` (ä¿æŒ)
- [x] `assistant` â†’ `assistant` (ä¿æŒ)

**Gemini**:
- [x] æ‰€æœ‰ `system` æ¶ˆæ¯åˆå¹¶ä¸º `system_instruction`
- [x] `assistant` â†’ `model`
- [x] `user` â†’ `user` (ä¿æŒ)

#### é‡è¦å‘ç°
Gemini çš„ç‰¹æ®Šå¤„ç†æŒ‰é¢„æœŸå·¥ä½œï¼š
- å¤šæ¡ system æ¶ˆæ¯æ­£ç¡®åˆå¹¶ä¸ºå•ä¸€ System Instructions
- assistant è§’è‰²æ­£ç¡®è½¬æ¢ä¸º model
- è½¬æ¢åçš„æ¶ˆæ¯æ•°é‡ç¬¦åˆé¢„æœŸ

---

### 4. æ³¨å…¥ç³»ç»Ÿ (3 ä¸ªæµ‹è¯•)

æµ‹è¯•äº†æç¤ºè¯æ³¨å…¥æœºåˆ¶ï¼š

#### æµ‹è¯•ç”¨ä¾‹
1. âœ… **æ·±åº¦0æ³¨å…¥** - åœ¨æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¹‹å‰æ³¨å…¥ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. âœ… **æ·±åº¦1æ³¨å…¥** - åœ¨å€’æ•°ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½ç½®æ³¨å…¥
3. âœ… **å¤šæ³¨å…¥æ’åº** - å¤šä¸ªæ³¨å…¥æŒ‰æ·±åº¦æ­£ç¡®æ’åº

#### åŠŸèƒ½éªŒè¯
- [x] æ·±åº¦0æ³¨å…¥ä½äºæœ€é«˜ä¼˜å…ˆçº§ä½ç½®
- [x] æ·±åº¦Næ³¨å…¥ä½äºå¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯ä½ç½®
- [x] å¤šä¸ªæ³¨å…¥å¯ä»¥å…±å­˜ä¸”æ­£ç¡®æ’åº

#### æ³¨å…¥ä½ç½®è¯´æ˜
```
æ·±åº¦0: æœ€åä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä¹‹å‰ (LLM å¼ºéµå®ˆ)
æ·±åº¦1: å€’æ•°ç¬¬1æ¡ç”¨æˆ·æ¶ˆæ¯ä½ç½®
æ·±åº¦2: å€’æ•°ç¬¬2æ¡ç”¨æˆ·æ¶ˆæ¯ä½ç½®
...
```

---

### 5. åå¤„ç†ç³»ç»Ÿ (11 ä¸ªæµ‹è¯•)

æµ‹è¯•äº†æç¤ºè¯åå¤„ç†çš„å„é¡¹åŠŸèƒ½ï¼š

#### æµ‹è¯•ç”¨ä¾‹
1. âœ… **å»é™¤å¤šä½™ç©ºè¡Œ** - è¿ç»­ç©ºè¡Œå‹ç¼©ä¸ºæœ€å¤š2ä¸ª
2. âœ… **å»é™¤è¡Œå°¾ç©ºç™½** - è¡Œå°¾ç©ºæ ¼è¢«æ¸…ç†
3. âœ… **ç©ºæ¶ˆæ¯è¿‡æ»¤** - ç©ºå†…å®¹æ¶ˆæ¯è¢«ç§»é™¤
4. âœ… **æ¶ˆæ¯å»é‡** - è¿ç»­é‡å¤æ¶ˆæ¯è¢«å»é™¤
5. âœ… **åˆå¹¶åŒè§’è‰²æ¶ˆæ¯** - è¿ç»­åŒè§’è‰²æ¶ˆæ¯å¯åˆå¹¶
6. âœ… **æ¶ˆæ¯æˆªæ–­** - è¶…é•¿æ¶ˆæ¯æŒ‰é…ç½®æˆªæ–­
7. âœ… **é«˜çº§åå¤„ç†é…ç½®** - æ”¯æŒå®Œæ•´çš„é…ç½®é€‰é¡¹

#### åŠŸèƒ½éªŒè¯

**æ ¼å¼åŒ–**:
- [x] å»é™¤å¤šä½™ç©ºè¡Œï¼ˆ>2ä¸ªè¿ç»­æ¢è¡Œï¼‰
- [x] å»é™¤è¡Œå°¾ç©ºç™½
- [x] è§„èŒƒåŒ–æ¢è¡Œç¬¦
- [x] å»é™¤é¦–å°¾ç©ºç™½

**å†…å®¹å¤„ç†**:
- [x] è¿‡æ»¤ç©ºæ¶ˆæ¯
- [x] å»é™¤é‡å¤æ¶ˆæ¯
- [x] åˆå¹¶è¿ç»­åŒè§’è‰²æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰

**é•¿åº¦æ§åˆ¶**:
- [x] å•æ¡æ¶ˆæ¯é•¿åº¦æ£€æŸ¥
- [x] æ€»Tokenæ•°ä¼°ç®—
- [x] è¶…é•¿ç­–ç•¥ï¼šwarn/truncate/error

#### é…ç½®ç¤ºä¾‹
```typescript
{
  enableDeduplication: true,
  enableEmptyFilter: true,
  enableMerging: false,
  enableFormatting: true,
  enableLengthCheck: true,
  maxMessageLength: 32000,
  lengthExceededStrategy: 'warn',
}
```

---

### 6. å®Œæ•´æ„å»ºæµç¨‹ (4 ä¸ªæµ‹è¯•)

æµ‹è¯•äº†ç«¯åˆ°ç«¯çš„æç¤ºè¯æ„å»ºï¼š

#### æµ‹è¯•ç”¨ä¾‹
1. âœ… **åŸºç¡€æ„å»º** - åªæœ‰ç³»ç»Ÿæç¤ºè¯
2. âœ… **å¸¦å†å²æ¶ˆæ¯** - åŒ…å«å¯¹è¯å†å²
3. âœ… **å¸¦æç¤ºè¯é…ç½®** - ä½¿ç”¨è§’è‰²é…ç½®
4. âœ… **å®åœ¨æ„å»ºä¸­å·¥ä½œ** - å®åœ¨å®Œæ•´æµç¨‹ä¸­æ­£ç¡®å±•å¼€

#### åŠŸèƒ½éªŒè¯
- [x] åŸºç¡€ç³»ç»Ÿæç¤ºè¯æ­£ç¡®åŠ è½½
- [x] å†å²æ¶ˆæ¯æ­£ç¡®åŒ…å«
- [x] æç¤ºè¯é…ç½®ç”Ÿæ•ˆ
- [x] å˜é‡ã€å ä½ç¬¦ã€å®å…¨éƒ¨æ­£ç¡®å¤„ç†

#### æ„å»ºæµç¨‹
```
1. åˆ›å»ºä¸Šä¸‹æ–‡
2. æ”¶é›†æ‰€æœ‰æç¤ºè¯é¡¹ï¼ˆè§’è‰² + å¯¹è¯ï¼‰
3. åˆ›å»ºå®å­˜å‚¨
4. å¤„ç†æ¯ä¸ªæç¤ºè¯é¡¹ï¼ˆå˜é‡ â†’ å ä½ç¬¦ â†’ å®ï¼‰
5. æ’åºæç¤ºè¯é¡¹
6. åˆ†ç¦»æ³¨å…¥é¡¹
7. æ„å»ºåŸºç¡€æ¶ˆæ¯
8. å¤„ç†æ³¨å…¥
9. Role é€‚é…
10. åå¤„ç†
```

---

### 7. ç»§æ‰¿å’Œè¦†ç›–é€»è¾‘ (2 ä¸ªæµ‹è¯•)

æµ‹è¯•äº†æç¤ºè¯çš„ç»§æ‰¿å’Œè¦†ç›–æœºåˆ¶ï¼š

#### æµ‹è¯•ç”¨ä¾‹
1. âœ… **åˆå¹¶æ¨¡å¼** - è§’è‰²æç¤ºè¯ + å¯¹è¯æç¤ºè¯åˆå¹¶
2. âœ… **è¦†ç›–æ¨¡å¼** - å¯¹è¯æç¤ºè¯è¦†ç›–è§’è‰²æç¤ºè¯

#### åŠŸèƒ½éªŒè¯
- [x] é»˜è®¤æ¨¡å¼ï¼šåˆå¹¶æ‰€æœ‰æç¤ºè¯
- [x] è¦†ç›–æ¨¡å¼ï¼šå¯¹è¯é…ç½®ä¼˜å…ˆ
- [x] ä¼˜å…ˆçº§ï¼šå¯¹è¯ > è§’è‰² > å…¨å±€

#### ä¼˜å…ˆçº§è¯´æ˜
```
ä¼˜å…ˆçº§: å¯¹è¯é…ç½® > è§’è‰²é…ç½® > å…¨å±€é¢„è®¾

åˆå¹¶æ¨¡å¼ (overrideCharacter: false):
  æœ€ç»ˆæç¤ºè¯ = å…¨å±€é¢„è®¾ + è§’è‰²é…ç½® + å¯¹è¯é…ç½®

è¦†ç›–æ¨¡å¼ (overrideCharacter: true):
  æœ€ç»ˆæç¤ºè¯ = å¯¹è¯é…ç½®
```

---

### 8. å¤š Provider åœºæ™¯ (6 ä¸ªæµ‹è¯•)

æµ‹è¯•äº†ä¸åŒ LLM æä¾›å•†çš„å…¼å®¹æ€§ï¼š

#### æµ‹è¯•ç”¨ä¾‹
1. âœ… **OpenAI** - æ ‡å‡†æ ¼å¼æ”¯æŒ
2. âœ… **Gemini** - System Instructions åˆå¹¶
3. âœ… **Anthropic/Claude** - æ ‡å‡†æ ¼å¼æ”¯æŒ

#### åŠŸèƒ½éªŒè¯
- [x] OpenAI æ„å»ºæˆåŠŸï¼Œè§’è‰²ä¿æŒåŸæ ·
- [x] Gemini æ„å»ºæˆåŠŸï¼Œsystem åˆå¹¶ï¼Œassistant â†’ model
- [x] Claude æ„å»ºæˆåŠŸï¼Œè§’è‰²ä¿æŒåŸæ ·

#### Provider å¯¹æ¯”

| Provider | system | user | assistant |
|----------|--------|------|-----------|
| OpenAI | system | user | assistant |
| Claude | system | user | assistant |
| Gemini | system_instruction* | user | model |

\* Gemini å°†æ‰€æœ‰ system æ¶ˆæ¯åˆå¹¶ä¸ºå•ä¸€ System Instructions

---

### 9. è¾¹ç¼˜æ¡ˆä¾‹ (4 ä¸ªæµ‹è¯•)

æµ‹è¯•äº†å„ç§è¾¹ç¼˜æƒ…å†µå’Œé”™è¯¯å¤„ç†ï¼š

#### æµ‹è¯•ç”¨ä¾‹
1. âœ… **ç©ºé…ç½®** - å³ä½¿é…ç½®ä¸ºç©ºä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
2. âœ… **ç¦ç”¨çš„æç¤ºè¯** - è¢«æ­£ç¡®å¿½ç•¥
3. âœ… **è¶…é•¿æ¶ˆæ¯** - æ­£ç¡®è­¦å‘Šå’Œå¤„ç†
4. âœ… **ç‰¹æ®Šå­—ç¬¦** - ä¸å¯¼è‡´é”™è¯¯

#### åŠŸèƒ½éªŒè¯
- [x] ç©ºé…ç½®æ—¶ä½¿ç”¨é»˜è®¤å€¼
- [x] `enabled: false` çš„æç¤ºè¯è¢«å¿½ç•¥
- [x] è¶…é•¿æ¶ˆæ¯äº§ç”Ÿè­¦å‘Š
- [x] ç‰¹æ®Šå­—ç¬¦ï¼ˆå¼•å·ã€æ‹¬å·ç­‰ï¼‰æ­£ç¡®å¤„ç†

#### ç‰¹æ®Šå­—ç¬¦æµ‹è¯•
æµ‹è¯•é€šè¿‡çš„ç‰¹æ®Šå­—ç¬¦ï¼š
- åŒå¼•å· `"`
- å•å¼•å· `'`
- èŠ±æ‹¬å· `{{` `}}`
- å…¶ä»– Unicode å­—ç¬¦

---

## æµ‹è¯•è¦†ç›–èŒƒå›´

### æ ¸å¿ƒæ¨¡å—

âœ… **variables.ts** - ç³»ç»Ÿå˜é‡æ›¿æ¢
- `replaceVariables()`
- `getCurrentSystemVariables()`

âœ… **placeholders.ts** - å ä½ç¬¦æ›¿æ¢
- `replacePlaceholders()`
- `formatChatHistory()`

âœ… **macros.ts** - å®å¤„ç†
- `expandMacros()`
- `processSetvarMacros()`
- `processGetvarMacros()`
- `processRandomMacros()`
- `createMacroStore()`

âœ… **role-adapter.ts** - è§’è‰²é€‚é…
- `adaptRoleForProvider()`
- `adaptForGemini()`
- `adaptForOpenAI()`
- `adaptForAnthropic()`

âœ… **injection.ts** - æ³¨å…¥å¤„ç†
- `processInjections()`
- `calculateInsertPosition()`

âœ… **post-processor.ts** - åå¤„ç†
- `postProcess()`
- `advancedPostProcess()`
- `deduplicateMessages()`
- `mergeConsecutiveMessages()`
- `filterEmptyMessages()`
- `truncateMessage()`

âœ… **builder.ts** - ä¸»æ„å»ºå™¨
- `buildPrompt()`
- `buildPromptWithContext()`

### æ•°æ®ç»“æ„

âœ… **types/prompt.ts** - æ‰€æœ‰æç¤ºè¯ç›¸å…³ç±»å‹
- `PromptItem`
- `PromptInjection`
- `CharacterPromptConfig`
- `ConversationPromptConfig`
- `PostProcessConfig`

---

## æ€§èƒ½æŒ‡æ ‡

- **æµ‹è¯•æ‰§è¡Œæ—¶é—´**: 0.06 ç§’
- **æµ‹è¯•ç”¨ä¾‹æ•°é‡**: 56
- **å¹³å‡æ¯ä¸ªæµ‹è¯•**: ~1.07 æ¯«ç§’
- **å†…å­˜å ç”¨**: æ­£å¸¸èŒƒå›´

---

## å·²çŸ¥é™åˆ¶

1. **Token è®¡æ•°**: ç›®å‰ä½¿ç”¨å­—ç¬¦æ•°ä¼°ç®—ï¼Œæœªé›†æˆçœŸå®çš„ tokenizer
2. **UI ç»„ä»¶æµ‹è¯•**: æœ¬æ¬¡æœªåŒ…å« UI ç»„ä»¶çš„è‡ªåŠ¨åŒ–æµ‹è¯•
3. **æ€§èƒ½æµ‹è¯•**: æœªè¿›è¡Œå¤§è§„æ¨¡æ¶ˆæ¯çš„æ€§èƒ½æµ‹è¯•

---

## ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸï¼ˆPhase 1ï¼‰
1. é›†æˆçœŸå®çš„ tokenizerï¼ˆtiktoken æˆ– gpt-tokenizerï¼‰
2. æ·»åŠ  UI ç»„ä»¶çš„ç«¯åˆ°ç«¯æµ‹è¯•
3. æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¤„ç† 1000+ æ¶ˆæ¯ï¼‰

### ä¸­æœŸï¼ˆPhase 2ï¼‰
1. æ·»åŠ æ›´å¤šé¢„è®¾æ¨¡æ¿
2. æ”¯æŒè‡ªå®šä¹‰å®å®šä¹‰
3. å®ç°æç¤ºè¯ç‰ˆæœ¬æ§åˆ¶

### é•¿æœŸï¼ˆPhase 3ï¼‰
1. æç¤ºè¯å¸‚åœº/ç¤¾åŒºåˆ†äº«
2. AI è¾…åŠ©æç¤ºè¯ä¼˜åŒ–
3. å¤šè¯­è¨€æç¤ºè¯æ”¯æŒ

---

## ç»“è®º

Phase 0ï¼ˆæç¤ºè¯ç³»ç»Ÿï¼‰çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²ç»è¿‡å…¨é¢æµ‹è¯•å¹¶éªŒè¯æ­£å¸¸å·¥ä½œã€‚ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›å…¥ Phase 1ï¼ˆæ¸²æŸ“ä¸UIä¼˜åŒ–ï¼‰ã€‚

**æµ‹è¯•çŠ¶æ€**: âœ… **PASSED**  
**ç³»ç»ŸçŠ¶æ€**: âœ… **READY FOR PRODUCTION**

---

## é™„å½•

### è¿è¡Œæµ‹è¯•

```bash
cd emotichat
npx tsx scripts/test-prompt-integration.ts
```

### æµ‹è¯•è„šæœ¬

æµ‹è¯•è„šæœ¬ä½äº: [`scripts/test-prompt-integration.ts`](../scripts/test-prompt-integration.ts)

### ç›¸å…³æ–‡æ¡£

- [æç¤ºè¯ç³»ç»Ÿè®¾è®¡](./refactoring-plan.md#phase-0-æç¤ºè¯ç³»ç»Ÿ)
- [ç”¨æˆ·éœ€æ±‚è¯¦æƒ…](./user-requirements-detailed.md)
- [Role é€‚é…å™¨æ–‡æ¡£](./role-adapter.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-23  
**ç»´æŠ¤è€…**: EmotiChat Development Team