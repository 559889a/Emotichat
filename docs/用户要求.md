# EmotiChat 用户需求文档

> 项目定位：个人开源的情感陪护与角色扮演聊天客户端
> 最后更新：2025-11-25

---

## 核心设计原则

> **所有功能均用独立单元模块实现，保证项目的高度解耦。不可以都耦合在一起，那样维护和debug太灾难了。**

---

## 项目定位

> 提示词工程 + 以函数调用、MCP为主的AI Agent，专门用于**情感陪护、角色扮演**的LLM对话客户端

### 为什么做这个项目
- 因为酒馆（SillyTavern）过于重型和陈旧
- 需要一个轻量级、现代化的替代品

---

## 核心功能要求

### 1. 提示词处理机制（最核心）

#### 1.1 楼层（Layer）
- 定义：对对话中第n条消息的位置定位
- 规则：
  - 第一条消息（开场白）= 第0层楼
  - 第二条消息 = 第1层楼
  - 公式：`楼层编号 = 消息序号 - 1`

#### 1.2 深度（Depth）
- 定义：对用户消息的位置定位，为提示词注入而设计
- 规则：
  - 用户在对话窗口发送的那条消息 = 深度1
  - 上一条用户消息 = 深度2
  - 深度0 = 强制遵守的提示词位置

#### 1.3 注入（Injection）
- 定义：开启注入后，提示词将不会在原来的提示词序列之中，而是被后处理到要注入的位置
- 用途：实现强制遵守的提示词

#### 1.4 提示词组成
1. 预设
2. 用户设定
3. 角色设定
4. 对话窗口
5. 用户消息

#### 1.5 处理流程
```
原始提示词
  ↓
变量替换（{{time}}, {{location}}, {{device_info}}）
  ↓
占位符替换（{{user}}, {{chat_history}}, {{last_user_message}}）
  ↓
宏展开（{{setvar}}, {{getvar}}, {{random}}）
  ↓
Role适配（根据API类型自动转换）
  ↓
排序整合（按照组成结构排序）
  ↓
注入处理（处理注入的提示词）
  ↓
最终发送给LLM
```

---

### 2. 变量系统

#### 实时变量（浏览器权限）
| 变量 | 格式 | 说明 |
|------|------|------|
| `{{time}}` | 年月日时分 | 不精确到秒 |
| `{{location}}` | 省市 | 例：广东省 深圳市 |
| `{{device_info}}` | 设备类型 | 电脑/手机 |

#### 占位符
| 占位符 | 含义 |
|--------|------|
| `{{user}}` | 用户名称 |
| `{{char}}` | 角色名称 |
| `{{chat_history}}` | 对话窗口内所有上下文 |
| `{{last_user_message}}` | 最后一条用户消息 |

#### 宏
| 宏 | 格式 | 说明 |
|-----|------|------|
| setvar | `{{setvar::变量名::变量值}}` | 设定变量 |
| getvar | `{{getvar::变量名}}` | 获取变量 |
| random | `{{random::值1::值2::...}}` | 随机抽取 |

---

### 3. Role 后处理（极其重要）

> **绝对不可以透传！** 这个问题非常大

- 根据用户选择的API类型，自动适配其对role的后处理模式

**Gemini 特殊处理**：
- 强制把所有 `system` role 提示词合并
- 更改为 `System instructions`
- 通过请求体发送给模型

---

### 4. 预设系统

预设设置窗口结构：

**A. 参数设置**
- 包括：温度、top_p 等所有参数
- 用户可通过打勾形式决定发送哪些参数
- 数值调节支持：数值编辑窗口 + 滑动条

**B. 上下文限制**
- 不走 LLM 端口
- 走项目的内部计数器
- 用户选择不同接入端口，计数器也要不同

**C. 提示词编辑区**
- 用户可自由增减条目
- 在条目里编辑提示词
- 使用统一的提示词编辑器组件

---

### 5. 角色编辑页面

#### 移除内容
- 系统提示词（旧）
- 背景故事（旧）
- 高级配置（旧）

#### 保留但不发送给LLM
- 角色名称 - 仅用于UI显示
- 角色描述 - 仅用于用户备注

#### 新增内容
- 新的提示词机制
- 开场白编辑窗口（AI的第一条消息，第0层楼）

---

### 6. 渲染系统

#### 支持格式
- HTML渲染
- Markdown渲染
- 代码块渲染（含代码高亮开关）

#### 特殊字段渲染
| 字段类型 | 示例 | 渲染效果 |
|---------|------|---------|
| 引号包裹 | "这是内容" | 特殊背景色/高亮 |
| 括号包裹 | (这是内容) | 特殊背景色/高亮 |
| 自定义 | 用户可自由添加 | 自定义样式 |

#### CSS完全自定义工具
- 对话界面CSS完全自定义
- 添加到设置页面

---

### 7. Token 计数器

- 三种接入端口对应三种计数器
- 用项目本地来实现计数（不走LLM端口）

| API类型 | 计数方式 |
|---------|---------|
| OpenAI | tiktoken 或本地估算 |
| Gemini | 本地估算（中文1.5字符≈1token） |
| Anthropic | 本地估算 |

---

### 8. 统一提示词编辑器

全局使用统一的提示词编辑器，功能包括：

- **排序功能**：拖拽排序
- **注入功能**：深度注入配置
- **开关功能**：决定是否发送给AI
- **Role设定**：设定role为 user/model/system

---

### 9. Dev Mode（开发者模式）

目标用户：开发者、高端用户

功能需求：
- 查看项目的debug消息
- 查看请求体
- 开启后，页面50%为log页面

```
┌──────────────┬──────────────┐
│              │              │
│   聊天界面   │   Log面板    │
│              │              │
│   (50%)      │   (50%)      │
│              │              │
└──────────────┴──────────────┘
```

---

### 10. 流式计时器和思维链

#### 流式计时器
- 显示流式响应的耗时

#### 思维链可折叠
- 默认：`<think>` 标签内容为模型思维链
- 功能：用户可设置是否折叠显示
- 可配置：给用户设置权限（自定义思维链标签）

---

### 11. 函数调用

利用模型的函数调用能力实现：
- 计算器
- 天气查询
- 搜索
- 等等

---

### 12. MCP（Model Context Protocol）

参考设计：
- 参考VS Code的扩展管理样式
- 项目内部可以自由配置JSON
- 有个专门配置MCP的页面

---

### 13. JavaScript 运行时

设计理念：透过JavaScript来实现一些模型实现不了的东西

应用场景示例：
```javascript
onUserInput((input) => {
  if (input.includes('关键词')) {
    injectPrompt('特定的提示词内容');
  }
});
```

---

### 14. 正则表达式

功能：后处理模型的输出或输入

特性：
- 可选功能：用户可以开启/关闭
- 可作用于：提示词部分、模型输出、用户输入

作用模式：
- **实际修改模式**：真正修改内容
- **视觉效果修改模式**：仅在UI层面修改显示

---

## UI/UX 设计要求

### 整体风格
- **不要**：网页端LLM的交互体验
- **要**：正经客户端的感觉
- **参考反例**: SillyTavern（过于重型和陈旧）

### 设计目标
- 轻量级
- 现代化
- 直观
- 专业

---

## 架构原则

> **所有功能均用独立单元模块实现**

### 模块化要求
- 高度解耦
- 独立可测试
- 可替换
- 单一职责

### 示例模块划分
```
modules/
├── prompt-processor/     # 提示词后处理
├── role-adapter/         # Role适配器
├── variable-resolver/    # 变量解析器
├── macro-processor/      # 宏处理器
├── injection-handler/    # 注入处理器
├── token-counter/        # Token计数器
├── rendering-engine/     # 渲染引擎
├── function-calling/     # 函数调用
├── mcp-client/          # MCP客户端
└── javascript-runtime/   # JavaScript运行时
```

---

## 数据模型设计

```typescript
// 提示词项目
interface PromptItem {
  id: string;
  order: number;
  content: string;
  enabled: boolean;
  role: 'system' | 'user' | 'assistant';
  injection?: {
    enabled: boolean;
    depth: number;
    position: 'before' | 'after' | 'replace';
  };
}

// 预设
interface Preset {
  id: string;
  name: string;
  parameters: ModelParameters;
  enabledParameters: Set<string>;
  contextLimit: {
    maxTokens: number;
    strategy: 'sliding_window' | 'summary';
  };
  prompts: PromptItem[];
}

// 角色
interface Character {
  id: string;
  name: string;         // 仅UI显示
  description: string;  // 仅用户备注
  avatar?: string;
  openingMessage: string;  // 开场白
  prompts: PromptItem[];
}

// 渲染配置
interface RenderingConfig {
  markdown: boolean;
  html: boolean;
  codeHighlight: {
    enabled: boolean;
    theme: string;
  };
  specialFields: {
    quoted: { enabled: boolean; style: CSSProperties };
    parenthesized: { enabled: boolean; style: CSSProperties };
  };
  customCSS: string;
}
```
